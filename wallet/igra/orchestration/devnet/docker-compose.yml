services:
  igra-signer-1:
    build:
      context: ../../../..
      dockerfile: wallet/igra/orchestration/devnet/igra/Dockerfile
      args:
        IGRA_REPO: "https://github.com/reshmem/rusty-kaspa.git"
        IGRA_REF: "${IGRA_REF:-devel}"
    image: igra-service-devnet
    depends_on:
      - kaspad
    environment:
      - KASPA_DATA_DIR=/data/igra
      - IGRA_RPC_URL=http://127.0.0.1:8088/rpc
      - IGRA_PROFILE=signer-01
      - IGRA_SECRETS_PASSPHRASE=devnet-secret
      - HYPERLANE_KEYS_PATH=/data/igra/hyperlane-keys.json
      - HYPERLANE_INTERVAL_SECS=10
      - HYPERLANE_START_EPOCH_SECS=0
      - HYPERLANE_AMOUNT_SOMPI=20000000
      - HYPERLANE_RECIPIENT_PAYLOAD=000000000000000000000000000000000000000000000000000000000000dead
      - HYPERLANE_DOMAIN=5
      - HYPERLANE_DESTINATION_DOMAIN=7
      - HYPERLANE_SENDER=0x0
    ports:
      - "8088:8088"
    volumes:
      - igra-data-1:/data/igra
      - ./igra-devnet.toml:/data/igra/igra-config.toml:ro
      - ./hyperlane-keys.json:/data/igra/hyperlane-keys.json:ro

  igra-signer-2:
    image: igra-service-devnet
    depends_on:
      - kaspad
      - igra-signer-1
    environment:
      - KASPA_DATA_DIR=/data/igra
      - IGRA_RPC_URL=http://127.0.0.1:8089/rpc
      - IGRA_PROFILE=signer-02
      - IGRA_SECRETS_PASSPHRASE=devnet-secret
      - HYPERLANE_KEYS_PATH=/data/igra/hyperlane-keys.json
      - HYPERLANE_INTERVAL_SECS=10
      - HYPERLANE_START_EPOCH_SECS=0
      - HYPERLANE_AMOUNT_SOMPI=20000000
      - HYPERLANE_RECIPIENT_PAYLOAD=000000000000000000000000000000000000000000000000000000000000dead
      - HYPERLANE_DOMAIN=5
      - HYPERLANE_DESTINATION_DOMAIN=7
      - HYPERLANE_SENDER=0x0
    ports:
      - "8089:8089"
    volumes:
      - igra-data-2:/data/igra
      - ./igra-devnet.toml:/data/igra/igra-config.toml:ro
      - ./hyperlane-keys.json:/data/igra/hyperlane-keys.json:ro

  igra-signer-3:
    image: igra-service-devnet
    depends_on:
      - kaspad
      - igra-signer-1
    environment:
      - KASPA_DATA_DIR=/data/igra
      - IGRA_RPC_URL=http://127.0.0.1:8090/rpc
      - IGRA_PROFILE=signer-03
      - IGRA_SECRETS_PASSPHRASE=devnet-secret
      - HYPERLANE_KEYS_PATH=/data/igra/hyperlane-keys.json
      - HYPERLANE_INTERVAL_SECS=10
      - HYPERLANE_START_EPOCH_SECS=0
      - HYPERLANE_AMOUNT_SOMPI=20000000
      - HYPERLANE_RECIPIENT_PAYLOAD=000000000000000000000000000000000000000000000000000000000000dead
      - HYPERLANE_DOMAIN=5
      - HYPERLANE_DESTINATION_DOMAIN=7
      - HYPERLANE_SENDER=0x0
    ports:
      - "8090:8090"
    volumes:
      - igra-data-3:/data/igra
      - ./igra-devnet.toml:/data/igra/igra-config.toml:ro
      - ./hyperlane-keys.json:/data/igra/hyperlane-keys.json:ro

  kaspad:
    build:
      context: ../../../..
      dockerfile: wallet/igra/orchestration/devnet/kaspa/Dockerfile.kaspad
    image: kaspa-devnet-kaspad
    command:
      - kaspad
      - --devnet
      - --utxoindex
      - --appdir=/data
      - --rpcserver=0.0.0.0:16110
      - --listen=0.0.0.0:16111
    ports:
      - "16110:16110"
      - "16111:16111"
    volumes:
      - kaspad-data:/data

  kaspaminer:
    build:
      context: ../../../..
      dockerfile: wallet/igra/orchestration/devnet/kaspa/Dockerfile.kaspaminer
      args:
        KASPA_MINER_REPO: "${KASPA_MINER_REPO:-https://github.com/IgraLabs/kaspa-miner.git}"
        KASPA_MINER_REF: "${KASPA_MINER_REF:-main}"
    image: kaspa-devnet-kaspaminer
    depends_on:
      - kaspad
    command:
      - --kaspad-address=grpc://kaspad:16110
      - --devfund-percent=0
      - --mining-address=${KASPA_MINING_ADDRESS}
      - --mine-when-not-synced

  wallet:
    build:
      context: ../../../..
      dockerfile: wallet/igra/orchestration/devnet/kaspa/Dockerfile.rothschild
    image: kaspa-devnet-rothschild
    depends_on:
      - kaspad
    entrypoint: ["/bin/sh", "-c"]
    command: ["sleep infinity"]
    environment:
      - ROTHSCHILD_WALLET_DIR=/wallet
      - KASPA_NODE_RPC_URL=grpc://kaspad:16110
    volumes:
      - wallet-data:/wallet

volumes:
  kaspad-data:
  wallet-data:
  igra-data-1:
  igra-data-2:
  igra-data-3:
