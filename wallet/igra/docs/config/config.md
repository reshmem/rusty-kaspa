# Complete Configuration Reference

**Version:** 0.5.0
**Last Updated:** 2026-01-24
**Status:** ✅ CURRENT - Complete parameter documentation

---

## Overview

This document provides **complete reference documentation** for all Igra configuration parameters.

**Format:**
- Parameter name and type
- Default value
- Required/Optional status
- Description and usage
- Where used in code
- Security implications
- Examples

**For getting started:** See [README.md](README.md) or [examples.md](examples.md)

---

## Table of Contents

<!-- Auto-generated by mdbook-toc -->

---

## 1. Service Configuration (`[service]`)

Main service settings for RPC connectivity, data storage, and secret management.

### 1.1 service.network

**Type:** `String` (optional)
**Default:** `None`
**Environment:** `IGRA_SERVICE__NETWORK`

**Description:**
Network mode declaration for security validation. Must match `--network` CLI flag.

**Values:**
- `"mainnet"` - Production network (strict validation)
- `"testnet"` - Test network (moderate validation)
- `"devnet"` - Development network (permissive)

**Validation:**
- **Mainnet:** MUST be explicitly set to `"mainnet"` (prevents accidental use of test config)
- **Testnet:** Recommended to set (warns if missing)
- **Devnet:** Optional

**Used in:**
- `igra-core/src/infrastructure/network_mode/validator.rs` - Security validation
- `igra-service/src/bin/kaspa-threshold-service.rs` - Mode confirmation

**Security:** Critical for mainnet (enforces security rules)

**Example:**
```toml
[service]
network = "mainnet"  # Explicit confirmation required for mainnet
```

---

### 1.2 service.allow_remote_rpc

**Type:** `Boolean`
**Default:** `false`
**Environment:** `IGRA_SERVICE__ALLOW_REMOTE_RPC`
**CLI:** `--allow-remote-rpc`

**Description:**
Explicitly allow remote Kaspa RPC endpoints in mainnet (NOT RECOMMENDED).

**Purpose:**
Security validation only - prevents accidental remote RPC in production.

**Validation:**
- **Mainnet:** If `node_rpc_url` is remote, this MUST be `true` (or use `--allow-remote-rpc` flag)
- **Testnet/Devnet:** Not enforced

**Security WARNING:**
Remote RPC endpoints can:
- Lie about UTXO state (loss of funds risk)
- Track your transactions (privacy risk)
- Censor operations (liveness risk)

**Recommendation:** Run local kaspad node on same machine

**Used in:**
- `igra-core/src/infrastructure/network_mode/rules/rpc.rs` - RPC endpoint validation

**Example:**
```toml
[service]
node_rpc_url = "grpcs://token@remote-kaspad.example.com:16110"
allow_remote_rpc = true  # Explicit acknowledgment of risk
```

---

### 1.3 service.node_rpc_url

**Type:** `String`
**Default:** `"grpc://127.0.0.1:16110"`
**Environment:** `IGRA_SERVICE__NODE_RPC_URL`
**Required:** Yes

**Description:**
Kaspa node gRPC endpoint for UTXO queries and transaction submission.

**Format:** `<scheme>://[<auth>@]<host>:<port>[/<path>]`

**Schemes:**
- `grpc://` - Unencrypted gRPC (local only)
- `grpcs://` - TLS-encrypted gRPC (required for remote in mainnet)

**Validation:**
- **Mainnet:** Must be localhost (`127.0.0.1`, `localhost`, `::1`, `127.*`) unless `allow_remote_rpc=true`
- **Mainnet + Remote:** Must use `grpcs://` (TLS) and include auth (`user:pass@`)
- **Testnet:** Warns if remote and unencrypted
- **Devnet:** No restrictions

**Used in:**
- `igra-core/src/infrastructure/rpc/kaspa_grpc_client.rs` - gRPC client
- `igra-core/src/application/pskt_builder.rs` - UTXO queries
- `igra-service/src/service/flow.rs` - Transaction submission

**Performance:** Local RPC has ~1-5ms latency, remote has ~50-200ms

**Example:**
```toml
[service]
# Local (recommended)
node_rpc_url = "grpc://127.0.0.1:16110"

# Remote with TLS (mainnet requires grpcs://)
node_rpc_url = "grpcs://token@kaspad.example.com:16110"
```

---

### 1.4 service.data_dir

**Type:** `String`
**Default:** From `KASPA_DATA_DIR` or `"./.igra"`
**Environment:** `KASPA_DATA_DIR` or `IGRA_SERVICE__DATA_DIR`
**Required:** Yes

**Description:**
Data directory for RocksDB storage, audit logs, and secrets file.

**Contains:**
- `rocksdb/` - Event CRDT state, proposals, phase storage
- `key-audit.log` - Key operation audit trail
- `secrets.bin` - Encrypted secrets (if `use_encrypted_secrets=true`)
- `iroh/identity.json` - Iroh peer identity

**Validation:**
- **Mainnet:** Must exist and have 0700 permissions (owner-only)
- **Mainnet:** Must have ≥10 GB disk space
- **Mainnet:** Path must not contain "devnet" or "test" (prevents config drift)
- **Testnet:** Warns on loose permissions or low disk space

**Used in:**
- `igra-core/src/infrastructure/storage/rocks/` - RocksDB initialization
- `igra-core/src/infrastructure/keys/backends/file_secret_store.rs` - Secrets file path
- `igra-service/src/bin/kaspa-threshold-service/setup.rs` - Identity loading

**Security:** Critical - protects signing keys and transaction history

**Example:**
```toml
[service]
# Development
data_dir = "./.igra-devnet"

# Production
data_dir = "/var/lib/igra"
```

**Permissions:**
```bash
# Mainnet requires:
chmod 700 /var/lib/igra
```

---

### 1.5 service.allow_schema_wipe

**Type:** `Boolean`
**Default:** `false`
**Environment:** `IGRA_SERVICE__ALLOW_SCHEMA_WIPE`

**Description:**
**DEVNET-ONLY:** Automatically wipe RocksDB if schema version mismatches.

**Purpose:**
Enables rapid iteration during development without manual database cleanup.

**Validation:**
- **Mainnet:** Always `false` (hardcoded, cannot override)
- **Testnet:** Always `false`
- **Devnet:** Can be `true`

**DANGER:**
- ❌ NEVER use in production (data loss)
- ❌ Wipes ALL event history
- ❌ Wipes ALL signatures

**Used in:**
- `igra-core/src/infrastructure/storage/rocks/engine.rs` - Schema migration

**Example:**
```toml
[service]
allow_schema_wipe = true  # DEVNET ONLY
```

---

### 1.6 service.use_encrypted_secrets

**Type:** `Boolean`
**Default:** `false`
**Environment:** `IGRA_SERVICE__USE_ENCRYPTED_SECRETS`

**Description:**
Use encrypted `secrets.bin` file (FileSecretStore) instead of environment variables (EnvSecretStore).

**Validation:**
- **Mainnet:** MUST be `true` (error if false)
- **Testnet:** Recommended (warns if false)
- **Devnet:** Optional

**When true:**
- Secrets stored in `${data_dir}/secrets.bin` (or `service.secrets_file`)
- Encrypted with XChaCha20-Poly1305
- Key derived from passphrase via Argon2id
- Requires `IGRA_SECRETS_PASSPHRASE` env var

**When false:**
- Secrets loaded from environment variables
- Format: `IGRA_SECRET__<namespace>__<name>=<encoding>:<value>`
- Example: `IGRA_SECRET__igra_signer__private_key_signer_01="hex:deadbeef..."`

**Used in:**
- `igra-service/src/bin/kaspa-threshold-service/setup.rs:75` - Secret store selection

**Security:**
- FileSecretStore: ⭐⭐⭐⭐⭐ (encrypted, file permissions, audit trail)
- EnvSecretStore: ⭐⭐ (visible in process list, acceptable for devnet only)

**Example:**
```toml
[service]
use_encrypted_secrets = true  # Required for mainnet
```

**See:** [secrets-config.md](secrets-config.md) for complete secret management guide.

---

### 1.7 service.secrets_file

**Type:** `String` (optional)
**Default:** `"${data_dir}/secrets.bin"`
**Environment:** `IGRA_SERVICE__SECRETS_FILE`

**Description:**
Path to encrypted secrets file (when `use_encrypted_secrets=true`).

**Validation:**
- File must exist if `use_encrypted_secrets=true`
- **Mainnet:** Must have 0600 permissions (owner read/write only)
- **Testnet:** Warns on loose permissions

**File format:**
```
[0-3]   Magic: "ISEC"
[4]     Version: 1
[5-8]   Argon2 m_cost
[9-12]  Argon2 t_cost
[13-16] Argon2 p_cost
[17-48] Salt (32 bytes)
[49-72] Nonce (24 bytes)
[73-76] Rotation tag: "RTM1"
[77-84] created_at_nanos (u64 LE, unix nanos)
[85-92] last_rotated_at_nanos (u64 LE, unix nanos)
[93-..] Ciphertext + Tag
```

**Integrity:** Header fields are authenticated as AEAD associated data (AAD). Editing timestamps breaks decryption.

**Used in:**
- `igra-core/src/infrastructure/keys/backends/file_secret_store.rs` - File loading

**Example:**
```toml
[service]
secrets_file = "/etc/igra/secrets.bin"
```

---

#### service.passphrase_rotation_enabled

**Type:** `Boolean` (optional)  
**Default:** `true` (mainnet/testnet), `false` (devnet)  
**Environment:** `IGRA_SERVICE__PASSPHRASE_ROTATION_ENABLED`

Enable/disable passphrase rotation enforcement for `secrets.bin`.

---

#### service.passphrase_rotation_warn_days

**Type:** `u64` (optional)  
**Default:** `60` (mainnet), `90` (testnet), `0` (devnet)  
**Environment:** `IGRA_SERVICE__PASSPHRASE_ROTATION_WARN_DAYS`

Warn when `secrets.bin` passphrase age (days since `last_rotated_at_nanos`) reaches this threshold.

---

#### service.passphrase_rotation_error_days

**Type:** `u64` (optional)  
**Default:** `90` (mainnet), `0` (testnet/devnet)  
**Environment:** `IGRA_SERVICE__PASSPHRASE_ROTATION_ERROR_DAYS`

Error threshold (days) for passphrase age.

- `0` disables “error” enforcement (warn-only).
- In mainnet, exceeding this threshold blocks startup unless enforcement is disabled via `service.passphrase_rotation_enabled=false`.

---

### 1.8 service.key_audit_log_path

**Type:** `String` (optional)
**Default:** `"${data_dir}/key-audit.log"`
**Environment:** `IGRA_SERVICE__KEY_AUDIT_LOG_PATH`

**Description:**
Path for key operation audit log (JSON lines format).

**Log format:**
```json
{"timestamp_nanos":1234567890,"request_id":"req_abc","event":"SecretAccess","secret_name":"igra.signer.private_key_signer-01","operation":"Get","result":"Success"}
{"timestamp_nanos":1234567891,"request_id":"req_abc","event":"Signing","key_ref":"igra.signer.private_key_signer-01","payload_size":32,"signature_size":64,"duration_ms":2}
```

**Validation:**
- **Mainnet:** Parent directory must exist
- **Mainnet:** File must have 0600 permissions (if exists)

**Used in:**
- `igra-core/src/infrastructure/keys/audit.rs` - Audit logging
- `igra-service/src/bin/kaspa-threshold-service/modes/audit.rs` - Audit trail dump

**Retention:** Recommended minimum 90 days for compliance

**Example:**
```toml
[service]
key_audit_log_path = "/var/log/igra/key-audit.log"
```

**Query audit trail:**
```bash
# Dump audit trail for specific request
kaspa-threshold-service --audit req_abc123
```

---

### 1.9 service.node_rpc_circuit_breaker

**Type:** `Object`
**Default:** `{failure_threshold: 5, open_duration_secs: 30, success_threshold: 2}`

**Description:**
Circuit breaker configuration for Kaspa node RPC calls.

**Sub-parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `failure_threshold` | `u32` | `5` | Consecutive failures before opening circuit |
| `open_duration_secs` | `u64` | `30` | Max time circuit stays open |
| `success_threshold` | `u32` | `2` | Successes in half-open before closing |

**Behavior:**
- **Closed:** Normal operation, tracks failures
- **Open:** Rejects requests with exponential backoff (1s → `open_duration_secs`)
- **Half-Open:** Allows limited requests to probe recovery

**Used in:**
- `igra-core/src/infrastructure/rpc/kaspa_grpc_client.rs` - Circuit breaker wrapper

**Example:**
```toml
[service.node_rpc_circuit_breaker]
failure_threshold = 10
open_duration_secs = 60
success_threshold = 3
```

---

## 2. PSKT Configuration (`[service.pskt]`)

**See:** [pskt-config.md](pskt-config.md) for complete PSKT parameters.

**Quick reference:**
- `source_addresses` - Optional override; derived from redeem script
- `redeem_script_hex` - Multisig redeem script
- `sig_op_count` - Signature operation count (fee estimation)
- `fee_payment_mode` - Who pays fees (recipient/signers/split)
- `change_address` - Where to send change
- `outputs` - Static outputs (testing)

---

## 3. HD Wallet Configuration (`[service.hd]`)

**See:** [hd-wallet-config.md](hd-wallet-config.md) for complete HD wallet parameters.

**Quick reference:**
- `key_type` - `hd_mnemonic` or `raw_private_key`
- Signing secrets are loaded from SecretStore using the active profile (see `docs/dev/mnemonics-refactor.md`)
- `derivation_path` - HD derivation path
- `required_sigs` - Required signatures for redeem script

---

## 4. Group Configuration (`[group]`)

**See:** [group-config.md](group-config.md) for complete group parameters.

**Quick reference:**
- `threshold_m` - Required signatures (M-of-N)
- `threshold_n` - Total signers (N)
- `member_pubkeys` - Schnorr x-only pubkeys (32 bytes each)
- `session_timeout_seconds` - Session timeout
- Policy parameters (fees, finality, dust)

---

## 5. Policy Configuration (`[policy]`)

**See:** [policy-config.md](policy-config.md) for complete policy parameters.

**Quick reference:**
- `allowed_destinations` - Whitelist of recipient addresses
- `min_amount_sompi` - Minimum transaction amount
- `max_amount_sompi` - Maximum transaction amount
- `max_daily_volume_sompi` - Daily volume limit
- `require_reason` - Require reason in metadata

---

## 6. Iroh P2P Configuration (`[iroh]`)

**See:** [iroh-config.md](iroh-config.md) for complete Iroh parameters.

**Quick reference:**
- `peer_id` - This signer's peer identifier
- `group_id` - Gossip topic identifier
- `network_id` - Message filtering
- `bootstrap` - Bootstrap peer IDs
- `bootstrap_addrs` - Bootstrap multiaddrs
- `bind_port` - UDP/QUIC bind port
- `discovery` - Pkarr, DNS, relay configuration

**See also:** [iroh-discovery.md](iroh-discovery.md) for Pkarr DHT, relay, and discovery configuration.

---

## 7. Hyperlane Configuration (`[hyperlane]`)

**See:** [hyperlane-config.md](hyperlane-config.md) for complete Hyperlane parameters.

**Quick reference:**
- `validators` - Validator secp256k1 pubkeys
- `threshold` - Required validator signatures
- `domains` - Per-domain ISM configuration
- `poll_secs` - Event polling interval

---

## 8. Two-Phase Configuration (`[two_phase]`)

**See:** [two-phase-config.md](two-phase-config.md) for complete two-phase parameters.

**Quick reference:**
- `proposal_timeout_ms` - Proposal phase timeout
- `commit_quorum` - Required commits for consensus
- `min_input_score_depth` - Minimum UTXO finality
- `revalidate_inputs_on_commit` - Re-check UTXOs before commit

---

## 9. Runtime Configuration (`[runtime]`)

**See:** [runtime-config.md](runtime-config.md) for complete runtime parameters.

**Quick reference:**
- `session_timeout_seconds` - Session timeout
- `session_expiry_seconds` - Session cleanup
- `crdt_gc_interval_seconds` - GC interval
- `crdt_gc_ttl_seconds` - Completed state retention
- Testing parameters (`test_mode`, `test_recipient`, etc.)

---

## 10. RPC Configuration (`[rpc]`)

**See:** [rpc-config.md](rpc-config.md) for complete RPC parameters.

**Quick reference:**
- `addr` - Listen address
- `enabled` - Enable JSON-RPC server
- `token` - Optional bearer token
- `rate_limit_rps` - Rate limiting
- `rate_limit_burst` - Burst capacity

---

## 11. Signing Configuration (`[signing]`)

**Type:** `Object`
**Default:** `{backend: "threshold"}`

### 11.1 signing.backend

**Type:** `String`
**Default:** `"threshold"`
**Environment:** `IGRA_SIGNING__BACKEND`

**Description:**
Signing backend selection.

**Values:**
- `"threshold"` - Simple M-of-N multisig (Schnorr partial signatures)
- `"musig2"` - MuSig2 signature aggregation (NOT IMPLEMENTED - stub only)
- `"mpc"` - FROST MPC threshold signatures (NOT IMPLEMENTED - stub only)

**Validation:**
- Must be valid `SigningBackendKind`
- Cannot use `musig2` or `mpc` (return Unimplemented error)

**Used in:**
- `igra-core/src/domain/signing/mod.rs` - Backend dispatch
- `igra-service/src/service/flow.rs` - Service initialization

**Example:**
```toml
[signing]
backend = "threshold"  # Only working implementation currently
```

---

## 12. LayerZero Configuration (`[layerzero]`)

**See:** [layerzero-config.md](layerzero-config.md) for complete LayerZero parameters.

**Quick reference:**
- `endpoint_pubkeys` - LayerZero endpoint secp256k1 pubkeys

---

## 13. Profile System

**See:** [profiles.md](profiles.md) for complete profile system documentation.

**Format:**
```toml
[profiles.<profile-name>.<section>]
parameter = value
```

**Overrides:**
Any top-level configuration can be overridden per-profile.

**Usage:**
```bash
kaspa-threshold-service --profile signer-1
```

---

## Environment Variables Reference

**Complete list:** See [environment-variables.md](environment-variables.md)

**Most common:**
```bash
# Service
export IGRA_SERVICE__NODE_RPC_URL="grpc://10.0.0.1:16110"
export IGRA_SERVICE__DATA_DIR="/var/lib/igra"
export IGRA_SERVICE__USE_ENCRYPTED_SECRETS=true

# Secrets
export IGRA_SECRETS_PASSPHRASE="my-passphrase"

# Iroh Discovery
export IGRA_IROH__DISCOVERY__ENABLE_PKARR=true
export IGRA_IROH__RELAY__ENABLE=true

# RPC
export IGRA_RPC__ENABLED=true
export IGRA_RPC__ADDR="0.0.0.0:8088"
```

---

## Configuration Loading Process

### Order of Operations

```
1. Load compiled defaults
   ↓
2. Load TOML file (igra-config.toml)
   ↓
3. Apply profile overrides ([profiles.<name>])
   ↓
4. Apply environment variable overrides (IGRA_*)
   ↓
5. Validate schema (types, ranges, required fields)
   ↓
6. Validate security (network mode rules)
   ↓
7. Start service (or exit if --validate-only)
```

**Implementation:**
- `igra-core/src/infrastructure/config/loader.rs` - Figment-based loading
- `igra-core/src/infrastructure/config/validation.rs` - Schema validation
- `igra-core/src/infrastructure/network_mode/validator.rs` - Security validation

---

## Validation Rules

**See:** [validation.md](validation.md) for complete validation reference.

**Common validations:**
- Required fields must be present
- Threshold: M ≤ N, both > 0
- Addresses must be valid Kaspa format
- Pubkeys must be valid secp256k1 (33 or 65 bytes, or 32 for x-only)
- Timeouts must be in valid ranges
- File paths must exist (when required)
- File permissions must be secure (mainnet)

---

## Configuration Troubleshooting

### "missing service.pskt.source_addresses"

**Cause:** `source_addresses` is empty and the system could not derive it.

**Fix (recommended):**
1. Ensure `service.network` is set (`mainnet`/`testnet`/`devnet`)
2. Ensure `service.pskt.redeem_script_hex` is set (or can be derived from `[service.hd]`)

**Fix (override):**
```toml
[service.pskt]
source_addresses = ["kaspa:..."] # must match the address derived from redeem_script_hex
```

---

### "Mainnet requires local RPC endpoint"

**Cause:** Remote RPC URL in mainnet without explicit approval

**Fix Option 1 (Recommended):**
```toml
[service]
node_rpc_url = "grpc://127.0.0.1:16110"  # Use local
```

**Fix Option 2 (Not Recommended):**
```bash
# Explicit opt-in to risk
kaspa-threshold-service --network mainnet --allow-remote-rpc
```

---

### "Invalid threshold: m=3 > n=2"

**Cause:** Threshold M greater than total N

**Fix:**
```toml
[group]
threshold_m = 2  # M ≤ N
threshold_n = 3
```

---

### "Mainnet forbids KASPA_IGRA_WALLET_SECRET env var"

**Cause:** Legacy environment variable in use

**Fix:**
1. Create encrypted secrets file
2. Remove env var
3. Set `IGRA_SECRETS_PASSPHRASE` instead

```bash
# Remove legacy
unset KASPA_IGRA_WALLET_SECRET

# Use encrypted secrets
export IGRA_SECRETS_PASSPHRASE="my-passphrase"
```

---

## Related Documentation

**Configuration guides (by topic):**
- [Network Modes](network-modes.md) - Security validation (mainnet/testnet/devnet)
- [Iroh Discovery](iroh-discovery.md) - P2P discovery (pkarr, DHT, relay)
- [Secret Management](secrets-config.md) - FileSecretStore vs EnvSecretStore
- [Examples](examples.md) - Complete working configurations

**Security:**
- [Timing Attacks](../security/timing-attacks.md) - Cryptographic security
- [Key Management](../security/key-management-audit.md) - Key management audit

**Protocol:**
- [Two-Phase Protocol](../protocol/two-phase-consensus.md) - Consensus algorithm
- [Architecture](../protocol/architecture.md) - System design

---

**Next Steps:**
- Read section-specific docs for detailed parameter information
- Check [examples.md](examples.md) for complete working configurations
- Validate your config: `kaspa-threshold-service --validate-only`

---

**End of Master Configuration Reference**

For questions or corrections, see [troubleshooting](#configuration-troubleshooting) or file an issue.
